#!/bin/sh

prefix=$1

#
#  Source our common functions - this will let us install a Debian package.
#
if [ -e /usr/lib/xen-tools/common.sh ]; then
    . /usr/lib/xen-tools/common.sh
else
    echo "Installation problem"
fi

#
# Log our start
#
logMessage Script $0 starting

# Add puppet repository
echo "deb http://apt.puppetlabs.com <%= lsbdistcodename %> main dependencies" > ${prefix}/etc/apt/sources.list.d/puppetlabs.list
chroot ${prefix} "wget http://apt.puppetlabs.com/pubkey.gpg -O - | apt-key add -"
chroot ${prefix} apt-get update

#
#  Install puppet
#
installDebianPackage ${prefix} puppet facter hiera


#
#  Make sure puppet isn't running, this will cause our unmounting of the
# disk image to fail..
#
chroot ${prefix} /etc/init.d/puppet stop

#
#  Log our finish
#
logMessage Script $0 finished
